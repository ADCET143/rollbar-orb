version: 2.1

      description: |
        Commands for calling the Rollbar API.
        Requires `curl` and `jq` commands to be available
        The source for the Orb can be found here:
        https://github.com/rollbar/rollbar-orb/tree/master/src/rollbar

      commands:
        notify_deploy_started:
          description: |
            A step to notify Rollbar that the deploy of a project has started.
            Should be used in conjunction with notify_deploy_finish.
            Command will set a BASH ENV variable ROLLBAR_DEPLOY_ID with the ID of the deploy
          parameters:
            environment:
              type: string
              default: production
              description: The Rollbar environment. Defaults to production.
          steps:
              - run:
                  name: Rollbar - Notify Deploy Started
                  command: |
                    ROLLBAR_DEPLOY_ID=`curl https://api.rollbar.com/api/1/deploy/ \
                      --form access_token=$ROLLBAR_ACCESS_TOKEN \
                      --form environment=<< parameters.environment >> \
                      --form revision=$CIRCLE_SHA1 \
                      --form local_username=$CIRCLE_USERNAME \
                      --form status=started | jq -r '.data.deploy_id'`
                      echo "Created deploy $ROLLBAR_DEPLOY_ID"
                      echo "export ROLLBAR_DEPLOY_ID=$ROLLBAR_DEPLOY_ID" >> $BASH_ENV

        notify_deploy:
          description: |
            A step to notify Rollbar the project has been successfully deployed.
            A Rollbar access token is required to be set in the
            environment with the name `ROLLBAR_ACCESS_TOKEN`.
            Add this as the last step of your the job that you
            use to deploy.
          parameters:
            environment:
              type: string
              default: production
              description: The Rollbar environment. Defaults to production.
          steps:
            - run:
                name: Rollbar - Notify Deploy Succeeded
                command: |
                  curl https://api.rollbar.com/api/1/deploy/ \
                    --form access_token=$ROLLBAR_ACCESS_TOKEN \
                    --form environment=<< parameters.environment >> \
                    --form revision=$CIRCLE_SHA1 \
                    --form local_username=$CIRCLE_USERNAME
